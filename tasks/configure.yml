---

- name: Add vhost directories
  become: yes
  file:
    group: vmail
    owner: vmail
    path: "/var/mail/vhosts/{{ item }}"
    state: directory
  with_items: "{{ pdm_mailserver_virtual_domains }}"

- name: Looks for extra MySQL settings
  become: yes
  stat:
    path: /etc/mysql/conf.d/custom.cnf
  register: custom_cnf

- name: Remove anonymous user
  mysql_user:
    login_host: localhost
    login_user: "{{ pdm_mailserver_mysql_root_user }}"
    login_password: ""
    name: ""
    state: absent
  when: not custom_cnf.stat.exists

- name: Configure local MySQL root user password
  become: yes
  mysql_user:
    login_host: localhost
    login_user: "{{ pdm_mailserver_mysql_root_user }}"
    login_password: ""
    name: root
    password: "{{ pdm_mailserver_mysql_root_password }}"
    state: present
  when: not custom_cnf.stat.exists

- name: Configure cusom MySQL client options
  become: yes
  template:
    src: mysql/custom.cnf.j2
    dest: /etc/mysql/conf.d/custom.cnf
  notify:
    - restart mysql

- name: Create database structure file
  become: yes
  template:
    dest: /tmp/db_structure.sql
    src: mysql/db_structure.sql.j2

- name: Create database
  mysql_db:
    name: "{{ pdm_mailserver_mysql_database }}"
    state: present
    login_host: "{{ pdm_mailserver_mysql_host }}"
    login_user: "{{ pdm_mailserver_mysql_root_user }}"
    login_password: "{{ pdm_mailserver_mysql_root_password }}"
  notify:
    - import database

- name: Create database user
  mysql_user:
    name: "{{ pdm_mailserver_mysql_user }}"
    password: "{{ pdm_mailserver_mysql_password }}"
    priv: "{{ pdm_mailserver_mysql_database }}.*:ALL"
    host: "%"
    state: present
    login_host: "{{ pdm_mailserver_mysql_host }}"
    login_user: "{{ pdm_mailserver_mysql_root_user }}"
    login_password: "{{ pdm_mailserver_mysql_root_password }}"

- name: Create mailname
  become: yes
  template:
    dest: /etc/mailname
    src: postfix/mailname.j2
  notify:
    - restart postfix

- name: Create postfix configs
  become: yes
  template:
    dest: "/etc/postfix/{{ item }}"
    src: "postfix/{{ item }}.j2"
  notify:
    - restart postfix
  with_items:
    - mysql-virtual-mailbox-domains.cf
    - mysql-virtual-mailbox-maps.cf
    - mysql-virtual-alias-maps.cf
    - mysql-virtual-email2email.cf
    - master.cf

- name: Create dovecot configs
  become: yes
  template:
    owner: vmail
    group: dovecot
    mode: 0700
    dest: "/etc/dovecot/{{ item }}"
    src: "dovecot/{{ item }}.j2"
  notify:
    - restart dovecot
  with_items:
    - dovecot.conf
    - conf.d/10-mail.conf
    - conf.d/10-auth.conf
    - conf.d/auth-sql.conf.ext
    - dovecot-sql.conf.ext
    - conf.d/10-master.conf
    - conf.d/10-ssl.conf

- name: Update /etc/dovecot permissions
  become: yes
  file:
    group: dovecot
    mode: 0700
    owner: vmail
    path: /etc/dovecot
    state: directory
